HWID_HOLO     equ 0x9

HOLO_CLEAR equ 0
HOLO_DISPLAY_HEX equ 1
HOLO_DISPLAY_STRING equ 2

.data
data: dw 87,101,39,114,101,32,110,111,32,115,116,114,97,110,103,101,114,115,32,116,111,32,108,111,118,101,0,89,111,117,32,107,110,111,119,32,116,104,101,32,114,117,108,101,115,32,97,110,100,32,115,111,32,100,111,32,73,0,65,32,102,117,108,108,32,99,111,109,109,105,116,109,101,110,116,39,115,32,119,104,97,116,32,73,39,109,32,116,104,105,110,107,105,110,103,32,111,102,0,89,111,117,32,119,111,117,108,100,110,39,116,32,103,101,116,32,116,104,105,115,32,102,114,111,109,32,97,110,121,32,111,116,104,101,114,32,103,117,121,0,73,32,106,117,115,116,32,119,97,110,110,97,32,116,101,108,108,32,121,111,117,32,104,111,119,32,73,39,109,32,102,101,101,108,105,110,103,0,71,111,116,116,97,32,109,97,107,101,32,121,111,117,32,117,110,100,101,114,115,116,97,110,100,0,78,101,118,101,114,32,103,111,110,110,97,32,103,105,118,101,32,121,111,117,32,117,112,0,78,101,118,101,114,32,103,111,110,110,97,32,108,101,116,32,121,111,117,32,100,111,119,110,0,78,101,118,101,114,32,103,111,110,110,97,32,114,117,110,32,97,114,111,117,110,100,32,97,110,100,32,100,101,115,101,114,116,32,121,111,117,0,78,101,118,101,114,32,103,111,110,110,97,32,109,97,107,101,32,121,111,117,32,99,114,121,0,78,101,118,101,114,32,103,111,110,110,97,32,115,97,121,32,103,111,111,100,98,121,101,0,78,101,118,101,114,32,103,111,110,110,97,32,116,101,108,108,32,97,32,108,105,101,32,97,110,100,32,104,117,114,116,32,121,111,117,0,87,101,39,118,101,32,107,110,111,119,110,32,101,97,99,104,32,111,116,104,101,114,32,102,111,114,32,115,111,32,108,111,110,103,0,89,111,117,114,32,104,101,97,114,116,39,115,32,98,101,101,110,32,97,99,104,105,110,103,32,98,117,116,32,121,111,117,39,114,101,32,116,111,111,32,115,104,121,32,116,111,32,115,97,121,32,105,116,0,73,110,115,105,100,101,32,119,101,32,98,111,116,104,32,107,110,111,119,32,119,104,97,116,39,115,32,98,101,101,110,32,103,111,105,110,103,32,111,110,0,87,101,32,107,110,111,119,32,116,104,101,32,103,97,109,101,32,97,110,100,32,119,101,39,114,101,32,103,111,110,110,97,32,112,108,97,121,32,105,116,0,65,110,100,32,105,102,32,121,111,117,32,97,115,107,32,109,101,32,104,111,119,32,73,39,109,32,102,101,101,108,105,110,103,0,68,111,110,39,116,32,116,101,108,108,32,109,101,32,121,111,117,39,114,101,32,116,111,111,32,98,108,105,110,100,32,116,111,32,115,101,101,0,78,101,118,101,114,32,103,111,110,110,97,32,103,105,118,101,32,121,111,117,32,117,112,0,78,101,118,101,114,32,103,111,110,110,97,32,108,101,116,32,121,111,117,32,100,111,119,110,0,78,101,118,101,114,32,103,111,110,110,97,32,114,117,110,32,97,114,111,117,110,100,32,97,110,100,32,100,101,115,101,114,116,32,121,111,117,0,78,101,118,101,114,32,103,111,110,110,97,32,109,97,107,101,32,121,111,117,32,99,114,121,0,78,101,118,101,114,32,103,111,110,110,97,32,115,97,121,32,103,111,111,100,98,121,101,0,78,101,118,101,114,32,103,111,110,110,97,32,116,101,108,108,32,97,32,108,105,101,32,97,110,100,32,104,117,114,116,32,121,111,117,0,78,101,118,101,114,32,103,111,110,110,97,32,103,105,118,101,32,121,111,117,32,117,112,0,78,101,118,101,114,32,103,111,110,110,97,32,108,101,116,32,121,111,117,32,100,111,119,110,0,78,101,118,101,114,32,103,111,110,110,97,32,114,117,110,32,97,114,111,117,110,100,32,97,110,100,32,100,101,115,101,114,116,32,121,111,117,0,78,101,118,101,114,32,103,111,110,110,97,32,109,97,107,101,32,121,111,117,32,99,114,121,0,78,101,118,101,114,32,103,111,110,110,97,32,115,97,121,32,103,111,111,100,98,121,101,0,78,101,118,101,114,32,103,111,110,110,97,32,116,101,108,108,32,97,32,108,105,101,32,97,110,100,32,104,117,114,116,32,121,111,117,0,78,101,118,101,114,32,103,111,110,110,97,32,103,105,118,101,44,32,110,101,118,101,114,32,103,111,110,110,97,32,103,105,118,101,0,40,71,105,118,101,32,121,111,117,32,117,112,41,0,40,79,111,104,41,32,78,101,118,101,114,32,103,111,110,110,97,32,103,105,118,101,44,32,110,101,118,101,114,32,103,111,110,110,97,32,103,105,118,101,0,40,71,105,118,101,32,121,111,117,32,117,112,41,0,87,101,39,118,101,32,107,110,111,119,110,32,101,97,99,104,32,111,116,104,101,114,32,102,111,114,32,115,111,32,108,111,110,103,0,89,111,117,114,32,104,101,97,114,116,39,115,32,98,101,101,110,32,97,99,104,105,110,103,32,98,117,116,32,121,111,117,39,114,101,32,116,111,111,32,115,104,121,32,116,111,32,115,97,121,32,105,116,0,73,110,115,105,100,101,32,119,101,32,98,111,116,104,32,107,110,111,119,32,119,104,97,116,39,115,32,98,101,101,110,32,103,111,105,110,103,32,111,110,0,87,101,32,107,110,111,119,32,116,104,101,32,103,97,109,101,32,97,110,100,32,119,101,39,114,101,32,103,111,110,110,97,32,112,108,97,121,32,105,116,0,73,32,106,117,115,116,32,119,97,110,110,97,32,116,101,108,108,32,121,111,117,32,104,111,119,32,73,39,109,32,102,101,101,108,105,110,103,0,71,111,116,116,97,32,109,97,107,101,32,121,111,117,32,117,110,100,101,114,115,116,97,110,100,0,78,101,118,101,114,32,103,111,110,110,97,32,103,105,118,101,32,121,111,117,32,117,112,0,78,101,118,101,114,32,103,111,110,110,97,32,108,101,116,32,121,111,117,32,100,111,119,110,0,78,101,118,101,114,32,103,111,110,110,97,32,114,117,110,32,97,114,111,117,110,100,32,97,110,100,32,100,101,115,101,114,116,32,121,111,117,0,78,101,118,101,114,32,103,111,110,110,97,32,109,97,107,101,32,121,111,117,32,99,114,121,0,78,101,118,101,114,32,103,111,110,110,97,32,115,97,121,32,103,111,111,100,98,121,101,0,78,101,118,101,114,32,103,111,110,110,97,32,116,101,108,108,32,97,32,108,105,101,32,97,110,100,32,104,117,114,116,32,121,111,117,0,78,101,118,101,114,32,103,111,110,110,97,32,103,105,118,101,32,121,111,117,32,117,112,0,78,101,118,101,114,32,103,111,110,110,97,32,108,101,116,32,121,111,117,32,100,111,119,110,0,78,101,118,101,114,32,103,111,110,110,97,32,114,117,110,32,97,114,111,117,110,100,32,97,110,100,32,100,101,115,101,114,116,32,121,111,117,0,78,101,118,101,114,32,103,111,110,110,97,32,109,97,107,101,32,121,111,117,32,99,114,121,0,78,101,118,101,114,32,103,111,110,110,97,32,115,97,121,32,103,111,111,100,98,121,101,0,78,101,118,101,114,32,103,111,110,110,97,32,116,101,108,108,32,97,32,108,105,101,32,97,110,100,32,104,117,114,116,32,121,111,117,0,78,101,118,101,114,32,103,111,110,110,97,32,103,105,118,101,32,121,111,117,32,117,112,0,84,104,97,110,107,115,32,102,111,114,32,108,105,115,116,101,110,105,110,103,33,0
data_end:
initialized: dw 0
restore_valid: dw 0
restore_sp: dw 0

display: dw 0,0,0,0,0,0,0,0,0

.text
    jmp __start
_main:
    mov bp,sp
    sub sp,2
    mov [bp-1],0
    mov [bp-2],0
_main_outerloop:
    push [bp-1]
    push data
    push display
    call _RenderTextWindow
    add sp,3
    mov [bp-2],a
_main_innerloop:
    mov a,[bp-2]
    test a,a
    jz _main_doneinnerloop
    sub a,1
    mov [bp-2],a
    push [bp-2]
    call _DrawHexOnScreen
    add sp,2
    call _FinishTick
    jmp _main_innerloop
_main_doneinnerloop:
    mov a,[bp-1]
    add a,1
    mov [bp-1],a
    add a,data
    cmp a,data_end ; can't do assemble-time arithmetic :(
    jnz _main_offsetgood
    mov [bp-1],0
_main_offsetgood:
    jmp _main_outerloop

; int RenderTextWindow(int * display, int * str, int offset);
; returns how many frames the window should be displayed
_RenderTextWindow:
    push bp
    mov bp,sp
    sub sp,2
    push x

    mov [bp-1],0

    mov x,[bp+3]
    add x,[bp+4]
    mov [bp-2],x
    mov y,[bp+2]
    mov c,8
_RenderTextWindow_l1:
    test c,c
    jz _RenderTextWindow_l1d
    sub c,1
    mov b,[x]
    test b,b
    jz _RenderTextWindow_end
    mov [y],b
    add x,1
    add y,1
    jmp _RenderTextWindow_l1
_RenderTextWindow_l1d:
    mov a,[bp+4]
    test a,a
    jz _RenderTextWindow_longdelay
    mov x,[bp-2]
    mov a,[x-1]  ; if we are starting a new line
    or a,[x+8]   ; or ending a line, delay long
    test a,a
    jz _RenderTextWindow_longdelay
    mov [bp-1],1
    jmp _RenderTextWindow_end
_RenderTextWindow_longdelay:
    mov [bp-1],8
_RenderTextWindow_end:
    mov a,[bp-1]
    pop x
    mov sp,bp
    pop bp
    ret

; void ClearScreen(void);
_ClearScreen:
    push bp
    mov bp,sp
    mov a,HOLO_CLEAR
    hwi HWID_HOLO
    mov sp,bp
    pop bp
    ret

; void DrawHexOnScreen(int hex);
_DrawHexOnScreen:
    push bp
    mov bp,sp
    mov b,[bp+2]
    mov a,HOLO_DISPLAY_HEX
    hwi HWID_HOLO
    mov sp,bp
    pop bp
    ret

; void DrawStringOnScreen(int * str);
_DrawStringOnScreen:
    push bp
    mov bp,sp
    mov b,[bp+2]
    mov a,HOLO_DISPLAY_STRING
    hwi HWID_HOLO
    mov sp,bp
    pop bp
    ret

; void FinishTick(void);
_FinishTick:
    push bp
    mov bp,sp

    push display
    ;call _DrawStringOnScreen
    add sp,2

    call _WaitForNextTick
    mov sp,bp
    pop bp
    ret

__start:
    mov a,[restore_valid]
    test a,a
    jnz RestorePrevTickState
    mov a,[initialized]
    test a,a
    jnz _InvalidRestore
    mov a,1
    mov [initialized],a
    jmp _main

; void WaitForNextTick(void);
_WaitForNextTick:
    push bp
    mov [restore_sp],sp
    mov a,1
    mov [restore_valid],a
    brk
RestorePrevTickState:
    xor a,a
    mov [restore_valid],a
    mov sp,[restore_sp]
    pop bp
    ret

; void CrashPrgm(void);
_CrashPrgm:
    push 0xff90
    call _DrawHexOnScreen
    add sp,2
    call _WaitForNextTick
    jmp _CrashPrgm

; void InvalidRestore(void);
_InvalidRestore:
    push 0xff80
    call _DrawHexOnScreen
    add sp,2
    brk
